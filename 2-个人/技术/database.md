# 数据库

## mysql 基础

### 什么是事务（Transaction）？

+ 事务是数据库并发控制的基本单位，是用户定义的一个 sql 操作集合，这些操作要么都执行，要么都不执行。

+ 比如转账操作就是典型的事务，A 账户扣钱，B 账户加钱，要么都成功，要么都失败。

### 事务的四个基本特性是什么？

+ 事务的四个基本特性是：ACID，即原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持久性（Durability）。

+ 原子性（Atomicity）：事务是一个原子操作单元，其对数据的修改，要么全都执行，要么全都不执行。

+ 一致性（Consistency）：事务执行的结果必须是使数据库从一个一致性状态变到另一个一致性状态。简单来说就是：事务前后数据的完整性必须保持一致。

+ 隔离性（Isolation）：一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。

+ 持久性（Durability）：持久性也称永久性（Permanence），指一个事务一旦被提交了，那么对数据库中的数据的改变就是永久性的，即便是在数据库系统遇到故障的情况下也不会丢失提交事务的操作。

### 事务不进行并发控制，可能会产生的异常情况有哪些？

+ 会产生四种异常情况，即脏读（Dirty Read）、不可重复读（Non-Repeatable Read）、幻读（Phantom Read）和丢失修改（lost update）。

+ 幻读：一个事务第二次查会出现第一次没有的结果。

+ 非重复读：一个事务重复读两次得到不同的结果。

+ 脏读：一个事务读到了另一个事务未提交的数据。

+ 丢失修改：并发写入造成其中一些修改丢失。

### 为了解决并发控制异常，数据库提供了四种隔离级别，分别是什么？

+ 读未提交（Read Uncommitted）：允许脏读，一个事务可以读取另一个未提交事务的数据。

+ 读已提交（Read Committed）：允许不可重复读，一个事务只能读取另一个已提交事务的数据。

+ 可重复读（Repeatable Read）：允许幻读，一个事务在多次读取同一数据时，读取的数据是一致的。（Mysql InnoDB 默认实现可重复读级别）

+ 串行化（Serializable）：最高的隔离级别，完全服从 ACID 的隔离级别。所有的事务依次逐个执行，这样事务之间就完全不可能产生干扰，但是这种方式效率低下，比较耗数据库性能，一般不使用。

### 如何解决高并发场景下的插入重复

+ 在未使用分库分表的情况下，可以使用唯一索引来解决，但是这样会导致大量的重试，影响性能。

+ 使用异步队列来处理，比如分布式消息队列 kafka，将数据写入到 kafka 中，然后消费 kafka 中的数据写入到数据库中，这样就可以保证数据不会重复。

+ 使用 redis 等实现分布式锁，保证同一时间只有一个线程可以写入数据。

### 什么是乐观锁和悲观锁？

+ 悲观锁是先获取锁，再进行操作。一锁二查三更新。

+ 乐观锁是先进行操作，再获取锁。更新的时候发现数据已经变了就回滚。

+ 悲观锁适用于多写的场景，乐观锁适用于多读的场景。

+ 多写的场景指的是：写操作比较多，读操作比较少，这种情况下使用悲观锁可以保证数据的一致性。

+ 多读的场景指的是：读操作比较多，写操作比较少，这种情况下使用乐观锁可以提高性能。

### Mysql 常用的数据类型有哪些？

+ 数值类型：整型（int）、浮点型（float）、定点数（decimal）、双精度浮点型（double）、位类型（bit）。

+ 字符串类型：定长字符串（char）、变长字符串（varchar）、二进制字符串（binary）、变长二进制字符串（varbinary）、枚举类型（enum）、集合类型（set）。

+ 日期类型：日期（date）、时间（time）、日期时间（datetime）、时间戳（timestamp）、年（year）。

+ 其他类型：文本（text）、小文本（tinytext）、大文本（longtext）、二进制（blob）、大二进制（longblob）、JSON（json）。

### Mysql 常用的两种引擎是什么？

+ Mysql 常用的两种引擎是 InnoDB 和 MyISAM。

+ MyISAM 引擎不支持事务，而 InnoDB 支持事务。

+ MyISAM 引擎不支持外键，而 InnoDB 支持外键。

+ MyISAM 引擎不支持行级锁，而 InnoDB 支持行级锁。

+ 行级锁的意思是：当一个事务访问一行数据时，其他事务是不能访问该行数据的。

### 什么是左连接和右连接？

+ 左连接：左连接是以左表为基础的，左表中的全部数据都会显示出来，而右表中的数据只会显示符合条件的数据。

+ 右连接：右连接是以右表为基础的，右表中的全部数据都会显示出来，而左表中的数据只会显示符合条件的数据。

+ 左连接查询语句：`select * from 表1 left join 表2 on 表1.id = 表2.id`。

+ 右连接查询语句：`select * from 表1 right join 表2 on 表1.id = 表2.id`。

## mysql 索引

### 什么是索引？

+ 索引是一种特殊的文件（InnoDB 数据表上的索引是表空间的一个组成部分），它们包含着对数据表里所有记录的引用指针。

+ 索引是帮助 Mysql 高效获取数据的数据结构。

+ 索引是在存储引擎层实现的，而不是在服务器层实现的，所以不同的存储引擎具有不同的索引类型和实现，如：Mysql 的 MyISAM 和 InnoDB 存储引擎使用的索引就不一样。

+ Innodb 使用的是聚集索引，MyISAM 使用的是非聚集索引。聚集索引指的是按照每张表的主键构造一颗 B+ 树，同时叶子节点中存放的就是整张表的行记录数据，而非聚集索引指的是叶子节点不包含行记录的全部数据，而是包含相应的主键，这个主键实际上是指向数据所在的物理位置。

+ 索引可以包含一个或多个列，多个列可以叫做联合索引。

+ 索引分为唯一索引和非唯一索引，唯一索引的值必须唯一，但是可以有空值，非唯一索引的值可以不唯一，但是可以有空值。

### B+ 树查找时间复杂度

+ B+ 树是一种多路平衡查找树，它的每个节点最多包含 m 个孩子，m 被称为 B+ 树的阶，m 的大小取决于磁盘页的大小。

+ B+ 树的查找过程和二分查找类似，都是先取中间节点，然后根据比较结果决定向左还是向右查找，直到找到目标数据。

+ B+ 树的查找时间复杂度是 O(logn)。

+ B+ 树的插入、删除、更新时间复杂度也是 O(logn)。

+ B+ 树的插入、删除、更新操作都是在叶子节点进行的，所以 B+ 树的插入、删除、更新操作不会破坏树的结构，所以 B+ 树的插入、删除、更新操作不会引起树的重构。

### 慢 sql 优化

+ 使用 explain 命令查看 sql 语句的执行计划，看看是否使用了索引。

+ 使用 show profile 命令查看 sql 语句的执行时间。

+ 使用 show status 命令查看数据库的一些状态信息，如：数据库的连接数、数据库的锁状态等。

+ 使用 show processlist 命令查看数据库的连接信息，如：连接的 id、连接的用户、连接的主机、连接的状态等。

+ 使用 show variables 命令查看数据库的一些配置信息，如：数据库的版本、数据库的字符集等。

+ 使用 show engine innodb status 命令查看数据库的 innodb 状态信息。

## redis

### redis 如何实现分布式锁？

+ 使用 setnx 命令，setnx 命令是 set if not exists 的缩写，也就是当 key 不存在时才设置 key 的值。

+ 可以同时通过 expire 添加超时时间。

+ 锁的 value 可以使用 uuid 等随机数，这样可以保证每个线程的锁都是唯一的。

+ 释放锁的时候通过 uuid 判断是否是自己的锁，如果是自己的锁才能释放。
